<div
	id="mutsumi-chat-modal"
	class="mutsumi-chat-modal hidden"
	role="dialog"
	aria-modal="true"
	aria-labelledby="mutsumi-chat-title"
>
	<div class="mutsumi-chat-backdrop" data-mutsumi-close></div>
	<section class="mutsumi-chat-panel">
		<header class="mutsumi-chat-header">
			<div>
				<h2 id="mutsumi-chat-title">Mutsumi对话机</h2>
				<p>接入 Google AI Studio（Gemini API）</p>
			</div>
			<button type="button" class="mutsumi-icon-btn" data-mutsumi-close aria-label="关闭">✕</button>
		</header>

		<div class="mutsumi-chat-settings">
			<label>
				API Key
				<input id="mutsumi-api-key" type="password" placeholder="粘贴你的 Google AI Studio API Key" />
			</label>
			<label>
				模型
				<input id="mutsumi-model" type="text" value="gemini-2.5-flash" />
			</label>
		</div>

		<main id="mutsumi-chat-messages" class="mutsumi-chat-messages"></main>

		<form id="mutsumi-chat-form" class="mutsumi-chat-form">
			<input id="mutsumi-chat-input" type="text" placeholder="请输入你想和睦说的话..." required />
			<button type="submit">发送</button>
		</form>
	</section>
</div>

<style>
	.mutsumi-chat-modal {
		position: fixed;
		inset: 0;
		z-index: 120;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.mutsumi-chat-backdrop {
		position: absolute;
		inset: 0;
		background: rgba(0, 0, 0, 0.45);
		backdrop-filter: blur(3px);
	}

	.mutsumi-chat-panel {
		position: relative;
		z-index: 1;
		width: min(92vw, 620px);
		height: min(88vh, 760px);
		background: var(--card-bg, #fff);
		border: 1px solid rgba(255, 255, 255, 0.12);
		border-radius: 18px;
		display: flex;
		flex-direction: column;
		overflow: hidden;
	}

	.mutsumi-chat-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 14px 16px;
		border-bottom: 1px solid rgba(127, 127, 127, 0.18);
	}

	.mutsumi-chat-header h2 {
		margin: 0;
		font-size: 1.05rem;
		font-weight: 700;
	}

	.mutsumi-chat-header p {
		margin: 2px 0 0;
		font-size: 0.8rem;
		opacity: 0.72;
	}

	.mutsumi-icon-btn {
		border: none;
		background: transparent;
		font-size: 1rem;
		cursor: pointer;
		opacity: 0.75;
	}

	.mutsumi-chat-settings {
		display: grid;
		grid-template-columns: 1fr;
		gap: 8px;
		padding: 12px 16px;
		border-bottom: 1px solid rgba(127, 127, 127, 0.18);
	}

	.mutsumi-chat-settings label {
		font-size: 0.78rem;
		opacity: 0.82;
		display: flex;
		flex-direction: column;
		gap: 4px;
	}

	.mutsumi-chat-settings input {
		height: 36px;
		padding: 0 10px;
		border-radius: 10px;
		border: 1px solid rgba(127, 127, 127, 0.3);
		background: transparent;
	}

	.mutsumi-chat-messages {
		flex: 1;
		overflow-y: auto;
		padding: 14px 16px;
		display: flex;
		flex-direction: column;
		gap: 10px;
	}

	.mutsumi-msg {
		padding: 10px 12px;
		border-radius: 12px;
		max-width: 88%;
		line-height: 1.5;
		white-space: pre-wrap;
	}

	.mutsumi-msg.user {
		margin-left: auto;
		background: color-mix(in srgb, var(--primary) 18%, transparent);
	}

	.mutsumi-msg.assistant {
		background: color-mix(in srgb, #888 18%, transparent);
	}

	.mutsumi-chat-form {
		display: flex;
		gap: 8px;
		padding: 12px;
		border-top: 1px solid rgba(127, 127, 127, 0.18);
	}

	.mutsumi-chat-form input {
		flex: 1;
		height: 40px;
		padding: 0 12px;
		border-radius: 10px;
		border: 1px solid rgba(127, 127, 127, 0.3);
		background: transparent;
	}

	.mutsumi-chat-form button {
		height: 40px;
		padding: 0 16px;
		border-radius: 10px;
		border: none;
		background: var(--primary);
		color: white;
		cursor: pointer;
	}

	.hidden {
		display: none !important;
	}
</style>

<script>
	const CHAT_LINK = "#mutsumi-chat";

	type Role = "user" | "assistant";
	type Message = { role: Role; text: string };

	const initMutsumiDialog = () => {
		const modal = document.getElementById("mutsumi-chat-modal");
		if (!modal || (window as any).__mutsumiDialogReady) return;
		(window as any).__mutsumiDialogReady = true;

		const msgContainer = document.getElementById("mutsumi-chat-messages");
		const form = document.getElementById("mutsumi-chat-form") as HTMLFormElement | null;
		const input = document.getElementById("mutsumi-chat-input") as HTMLInputElement | null;
		const keyInput = document.getElementById("mutsumi-api-key") as HTMLInputElement | null;
		const modelInput = document.getElementById("mutsumi-model") as HTMLInputElement | null;

		if (!msgContainer || !form || !input || !keyInput || !modelInput) return;

		const history: Message[] = [];
		const storageKey = "mutsumi-ai-studio-key";
		const modelStorageKey = "mutsumi-ai-studio-model";

		keyInput.value = localStorage.getItem(storageKey) || "";
		modelInput.value = localStorage.getItem(modelStorageKey) || modelInput.value;

		const appendMessage = (role: Role, text: string) => {
			history.push({ role, text });
			const node = document.createElement("div");
			node.className = `mutsumi-msg ${role}`;
			node.textContent = text;
			msgContainer.appendChild(node);
			msgContainer.scrollTop = msgContainer.scrollHeight;
		};

		const openModal = () => {
			modal.classList.remove("hidden");
			input.focus();
			if (!history.length) {
				appendMessage("assistant", "你好，我是 Mutsumi 对话机。先填入你的 Google AI Studio API Key，然后就可以开始对话。\n⚠️ API Key 会保存在你当前浏览器 LocalStorage。");
			}
		};

		const closeModal = () => modal.classList.add("hidden");

		document.addEventListener("click", (event) => {
			const target = event.target as HTMLElement;
			const link = target.closest(`a[href='${CHAT_LINK}']`) as HTMLAnchorElement | null;
			if (link) {
				event.preventDefault();
				openModal();
				return;
			}
			if (target.closest("[data-mutsumi-close]")) {
				event.preventDefault();
				closeModal();
			}
		});

		document.addEventListener("keydown", (event) => {
			if (event.key === "Escape" && !modal.classList.contains("hidden")) {
				closeModal();
			}
		});

		const buildGeminiContents = () =>
			history.map((msg) => ({
				role: msg.role === "assistant" ? "model" : "user",
				parts: [{ text: msg.text }],
			}));

		const askGemini = async (apiKey: string, model: string) => {
			const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(apiKey)}`;
			const res = await fetch(endpoint, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({
					contents: buildGeminiContents(),
					generationConfig: { temperature: 0.85, topP: 0.95 },
				}),
			});
			if (!res.ok) {
				const errText = await res.text();
				throw new Error(errText || `HTTP ${res.status}`);
			}
			const data = await res.json();
			return (
				data?.candidates?.[0]?.content?.parts?.map((part: { text?: string }) => part.text || "").join("\n") ||
				"（未获取到有效回复）"
			);
		};

		form.addEventListener("submit", async (event) => {
			event.preventDefault();
			const question = input.value.trim();
			const apiKey = keyInput.value.trim();
			const model = modelInput.value.trim() || "gemini-2.5-flash";

			if (!question) return;
			if (!apiKey) {
				appendMessage("assistant", "请先输入 Google AI Studio API Key。");
				return;
			}

			localStorage.setItem(storageKey, apiKey);
			localStorage.setItem(modelStorageKey, model);

			appendMessage("user", question);
			input.value = "";
			appendMessage("assistant", "正在思考中...");

			try {
				const text = await askGemini(apiKey, model);
				const loadingNode = msgContainer.lastElementChild;
				if (loadingNode?.classList.contains("assistant")) {
					loadingNode.textContent = text;
				}
			} catch (error) {
				const loadingNode = msgContainer.lastElementChild;
				const errMsg = error instanceof Error ? error.message : "未知错误";
				if (loadingNode?.classList.contains("assistant")) {
					loadingNode.textContent = `调用失败：${errMsg}`;
				}
			}
		});
	};

	document.addEventListener("astro:page-load", initMutsumiDialog);
	initMutsumiDialog();
</script>
