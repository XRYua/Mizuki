---
import { Icon } from "astro-icon/components";
import { readdir, stat } from "node:fs/promises";
import path from "node:path";
import { siteConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import {
	getCategoryList,
	getSortedPosts,
	getTagList,
} from "../../utils/content-utils";
import { getPostUrl } from "../../utils/url-utils";
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 从配置中获取站点开始日期
const siteStartDate = siteConfig.siteStartDate || "2025-01-01";

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
	if (post.body) {
		let text = post.body;

		// 移除代码块
		text = text.replace(/```[\s\S]*?```/g, "");
		// 移除 ` 包裹的行内代码
		text = text.replace(/`[^`]+`/g, "");

		// 使用与 remark-content.mjs 完全一致的 CJK 正则
		const cjkPattern =
			/[\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\u3000-\u303f\uff00-\uffef]/g;

		const cjkMatches = text.match(cjkPattern);
		const cjkCount = cjkMatches ? cjkMatches.length : 0;

		// 计算非 CJK 单词数
		const nonCjkText = text.replace(cjkPattern, " ");

		// 按空白字符分割，计算单词数量
		const nonCjkWords = nonCjkText
			.split(/\s+/)
			.filter((word) => word.trim().length > 0);

		totalWords += cjkCount + nonCjkWords.length;
	}
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
	return num.toLocaleString();
}

// 获取最新文章日期（忽略置顶状态，只按发布日期排序）
const latestPost = posts.reduce((latest, post) => {
	if (!latest) return post;
	return post.data.published > latest.data.published ? post : latest;
}, posts[0]);

const lastPostDate = latestPost
	? latestPost.data.published.toISOString()
	: null;

// 获取最近编辑的文章（按 frontmatter updated 字段）
const postsWithUpdated = posts.filter((post) => post.data.updated);
const latestEditedPost = postsWithUpdated.reduce(
	(latest, post) => {
		if (!latest) return post;
		return post.data.updated! > latest.data.updated! ? post : latest;
	},
	postsWithUpdated[0],
);

const lastEditedDate = latestEditedPost?.data.updated?.toISOString() || null;

// 获取博客最近文件改动（按 markdown 文件 mtime）
const postsBaseDir = path.resolve("src/content/posts");

async function getMarkdownFiles(dir: string): Promise<string[]> {
	const entries = await readdir(dir, { withFileTypes: true });
	const files = await Promise.all(
		entries.map(async (entry) => {
			const fullPath = path.join(dir, entry.name);
			if (entry.isDirectory()) {
				return getMarkdownFiles(fullPath);
			}
			if (entry.isFile() && fullPath.endsWith(".md")) {
				return [fullPath];
			}
			return [];
		}),
	);
	return files.flat();
}

let latestChangedEntry: { postId: string; changedAt: Date } | null = null;
const markdownFiles = await getMarkdownFiles(postsBaseDir);

for (const file of markdownFiles) {
	const fileStats = await stat(file);
	const relativePath = path.relative(postsBaseDir, file).replace(/\\/g, "/");
	const postId = relativePath.replace(/\.md$/, "");

	if (!latestChangedEntry || fileStats.mtime > latestChangedEntry.changedAt) {
		latestChangedEntry = {
			postId,
			changedAt: fileStats.mtime,
		};
	}
}

const latestChangedPost = latestChangedEntry
	? posts.find((post) => post.id === latestChangedEntry!.postId)
	: null;

const blogLastChangeDate = latestChangedEntry
	? latestChangedEntry.changedAt.toISOString()
	: null;

const candidateDates = [lastEditedDate, lastPostDate, blogLastChangeDate]
	.filter(Boolean)
	.map((date) => new Date(date!));

const lastActivityDate =
	candidateDates.length > 0
		? new Date(Math.max(...candidateDates.map((d) => d.getTime()))).toISOString()
		: null;

const activityCatalog = [
	{
		label: "最后编辑文章",
		icon: "material-symbols:edit-note-rounded",
		title: latestEditedPost?.data.title || "-",
		url: latestEditedPost ? getPostUrl(latestEditedPost) : null,
		time: lastEditedDate,
	},
	{
		label: "最后发表文章",
		icon: "material-symbols:publish-rounded",
		title: latestPost?.data.title || "-",
		url: latestPost ? getPostUrl(latestPost) : null,
		time: lastPostDate,
	},
	{
		label: "博客最后改动内容",
		icon: "material-symbols:history-rounded",
		title: latestChangedPost?.data.title || latestChangedEntry?.postId || "-",
		url: latestChangedPost ? getPostUrl(latestChangedPost) : null,
		time: blogLastChangeDate,
	},
];

const stats = [
	{
		icon: "material-symbols:article-outline",
		label: i18n(I18nKey.siteStatsPostCount),
		value: posts.length,
	},
	{
		icon: "material-symbols:folder-outline",
		label: i18n(I18nKey.siteStatsCategoryCount),
		value: categories.length,
	},
	{
		icon: "material-symbols:label-outline",
		label: i18n(I18nKey.siteStatsTagCount),
		value: tags.length,
	},
	{
		icon: "material-symbols:text-ad-outline-rounded",
		label: i18n(I18nKey.siteStatsTotalWords),
		value: totalWords,
		formatted: true,
	},
	{
		icon: "material-symbols:calendar-clock-outline",
		label: i18n(I18nKey.siteStatsRunningDays),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDays).replace("{days}", ""),
		dynamic: true,
		id: "running-days",
	},
	{
		icon: "material-symbols:ecg-heart-outline",
		label: i18n(I18nKey.siteStatsLastUpdate),
		value: 0, // 将由客户端更新
		dynamic: true,
		id: "last-update",
	},
];
---

<WidgetLayout
	name={i18n(I18nKey.siteStats)}
	id="site-stats"
	class={className}
	style={style}
>
	<div class="flex flex-col gap-1">
		{
			stats.map((stat) => (
				<div class="flex items-center justify-between px-2 py-2">
					<div class="flex items-center gap-2.5 flex-1 min-w-0">
						<div class="text-[var(--primary)] text-xl shrink-0">
							<Icon name={stat.icon} />
						</div>
						<span class="text-neutral-700 dark:text-neutral-300 font-medium text-sm break-words leading-tight">
							{stat.label}
						</span>
					</div>
					<div class="flex items-center ml-3 shrink-0">
						<span
							class="text-base font-bold text-neutral-900 dark:text-neutral-100"
							data-stat-id={stat.id}
						>
							{stat.formatted
								? formatNumber(stat.value)
								: stat.value}
						</span>
						{stat.suffix && (
							<span class="text-sm text-neutral-500 dark:text-neutral-400 ml-1">
								{stat.suffix}
							</span>
						)}
					</div>
				</div>
			))
		}
	</div>
	<div class="mt-2 px-2 pb-2 border-t border-black/5 dark:border-white/10">
		<details class="group">
			<summary class="list-none cursor-pointer select-none flex items-center justify-between py-2 rounded-lg px-2 transition hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)]">
				<span class="font-medium text-sm text-neutral-800 dark:text-neutral-200">最后活动目录</span>
				<Icon name="material-symbols:keyboard-arrow-down-rounded" class="text-xl text-[var(--primary)] transition-transform group-open:rotate-180" />
			</summary>
			<ul class="mt-1 space-y-1">
				{activityCatalog.map((item) => (
					<li>
						<div class="group flex items-center justify-between py-2 pl-3 pr-2 rounded-lg gap-3 hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] transition">
							<div class="flex items-center min-w-0 gap-2">
								<Icon name={item.icon} class="text-[1.05rem] text-[var(--primary)] shrink-0" />
								<div class="min-w-0">
									<div class="text-[11px] text-neutral-500 dark:text-neutral-400">{item.label}</div>
									{item.url ? (
										<a href={item.url} class="block text-sm font-medium text-neutral-800 dark:text-neutral-200 truncate hover:text-[var(--primary)] transition">{item.title}</a>
									) : (
										<span class="block text-sm font-medium text-neutral-800 dark:text-neutral-200 truncate">{item.title}</span>
									)}
								</div>
							</div>
							<div class="text-[11px] text-right text-neutral-500 dark:text-neutral-400 shrink-0">
								{item.time
									? new Date(item.time).toLocaleString("zh-CN", {
										dateStyle: "short",
										timeStyle: "medium",
									})
									: "-"}
							</div>
						</div>
					</li>
				))}
			</ul>
		</details>
	</div>
</WidgetLayout>

<script is:inline define:vars={{ siteStartDate, lastActivityDate }}>
	function updateDynamicStats() {
		const today = new Date();

		// 更新运行天数
		const startDate = new Date(siteStartDate);
		const diffTime = Math.abs(today.getTime() - startDate.getTime());
		const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

		const runningDaysElements = document.querySelectorAll(
			'[data-stat-id="running-days"]',
		);
		if (runningDaysElements.length > 0) {
			runningDaysElements.forEach(element => {
				element.textContent = diffDays.toString();
			});
		}

		// 更新最后活动时间
		if (lastActivityDate) {
			const lastActivity = new Date(lastActivityDate);
			const elapsedMs = Math.abs(today.getTime() - lastActivity.getTime());
			const days = Math.floor(elapsedMs / (1000 * 60 * 60 * 24));

			const lastUpdateElements = document.querySelectorAll(
				'[data-stat-id="last-update"]',
			);
			if (lastUpdateElements.length > 0) {
				lastUpdateElements.forEach((element) => {
					if (days < 16) {
						const hours = Math.floor((elapsedMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
						const minutes = Math.floor((elapsedMs % (1000 * 60 * 60)) / (1000 * 60));
						const seconds = Math.floor((elapsedMs % (1000 * 60)) / 1000);
						element.textContent = `${days}天 ${hours}时 ${minutes}分 ${seconds}秒`;
					} else {
						element.textContent = `${days} 天前`;
					}
				});
			}
		}
	}

	// 页面加载时更新
	updateDynamicStats();

	// 每小时更新一次（可选，因为天数变化较慢）
	setInterval(updateDynamicStats, 1000);
</script>
